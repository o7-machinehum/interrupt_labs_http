<head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="I’m building an open-source USB drive with a hidden obfuscation If you plug the device in normally, it will appear blank, but if you quickly plug it i"><meta name="author" content="Ryan Walker"><meta property="og:title" content="I Built a Self-Destructing USB Drive Part 3"><meta property="og:description" content="I’m building an open-source USB drive with a hidden obfuscation If you plug the device in normally, it will appear blank, but if you quickly plug it i"><meta property="og:site_name" content="Interrupt Labs Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://interruptlabs.caimg/home-bg.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://interruptlabs.caimg/home-bg.jpg"><title>I Built a Self-Destructing USB Drive Part 3 - Interrupt Labs Blog</title><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/style.css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=G-JPDQ8MSX3T"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JPDQ8MSX3T")</script><link rel="icon" href="/img/logo.png"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="Interrupt Labs Blog" type="application/rss+xml">
</head><nav><a class="navbar-brand" href="/"><img src="/img/home-icon.png" alt="Homepage" style="width:60px"></a></nav><style>.column{float:left;width:50%}.row:after{content:"";display:table;clear:both}.stroke{-webkit-text-stroke:1px #000}</style><header class="intro-header" style="background-image:url(/img/built_usb.jpg)"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1 class="stroke">I Built a Self-Destructing USB Drive Part 3</h1><span class="meta">2023-02-06</span></div></div></div></div></header><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div><div class="column"><a href="/2022/08/31/I-m-Building-a-Self-Destructing-USB-Drive-Part-2/">&lt&lt Previous Post</a> &#8205</div><div class="column" , style="text-align:right"></div></div><br><hr><p>I’m building an open-source USB drive with a hidden obfuscation If you plug the device in normally, it will appear blank, but if you quickly plug it in three times in a row, you will be able to read and write data. We built Ovrdrive for journalists working in hostile environments, security researchers, and anyone interested in open hardware.</p><p align="center"><a target="_blank" rel="noopener" href="https://shop.interruptlabs.ca/products/ovrdrive-usb">Device for Sale Now!</a></p><hr><p>I ended my last post with the design finished and the boards on order. Once I received the boards I built them up. I used a reflow hotplate for the top, and heat gun for the bottom.</p><p><img src="/img/usb-device.png"></p><p>After plugging the device into my PC, the USB flash controller enumerated and seemed to be working. All three voltage rails came up and looked stable. The dmesg logs got past the <code>USB</code> driver, the <code>usb-storage</code> driver, the <code>scsi</code> driver, but errored out on the <code>sd</code> driver. <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/drivers/scsi/sd.c#L2118">This is the section</a> of code where it was erroring out. Interestingly, the same message is produced when you plug in an sd card reader with no SD card. Here’s the error message:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[1676446.082295] usb 3-1: new high-speed USB device number 16 using ehci-pci</span><br><span class="line">[1676446.240444] usb 3-1: New USB device found, idVendor=090c, idProduct=3000, bcdDevice= 1.00</span><br><span class="line">[1676446.240463] usb 3-1: New USB device strings: Mfr=1, Product=2, SerialNumber=0</span><br><span class="line">[1676446.240467] usb 3-1: Product: SM3255AA MEMORY BAR</span><br><span class="line">[1676446.240470] usb 3-1: Manufacturer: Silicon Motion,Inc.</span><br><span class="line">[1676446.240926] usb-storage 3-1:1.0: USB Mass Storage device detected</span><br><span class="line">[1676446.241158] scsi host7: usb-storage 3-1:1.0</span><br><span class="line">[1676447.260193] scsi 7:0:0:0: Direct-Access USB MEMORY BAR   1000 PQ: 0 ANSI: 0 CCS</span><br><span class="line">[1676447.261910] sd 7:0:0:0: [sdg] Media removed, stopped polling</span><br><span class="line">[1676447.262814] sd 7:0:0:0: [sdg] Attached SCSI removable disk</span><br></pre></td></tr></table></figure><p>It looks like this so-called “block device” isn’t showing any blocks.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[machinehum@whitebox photos]$ lsblk</span><br><span class="line">NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span><br><span class="line">sda      8:0    0 111.8G  0 disk</span><br><span class="line">├─sda1   8:1    0   200M  0 part /boot</span><br><span class="line">├─sda2   8:2    0    12G  0 part [SWAP]</span><br><span class="line">└─sda3   8:3    0  99.6G  0 part /</span><br><span class="line">sdb      8:16   0 476.9G  0 disk /home</span><br><span class="line">sdc      8:32   0   489G  0 disk</span><br><span class="line">├─sdc1   8:33   0 469.2G  0 part</span><br><span class="line">├─sdc2   8:34   0     1K  0 part</span><br><span class="line">└─sdc5   8:37   0  19.8G  0 part</span><br><span class="line">sdd      8:48   0 931.5G  0 disk</span><br><span class="line">└─sdd1   8:49   0 931.5G  0 part /mov</span><br><span class="line">sde      8:64   0 931.5G  0 disk</span><br><span class="line">└─sde2   8:66   0 931.5G  0 part /dat</span><br><span class="line">sdg      8:96   1     0B  0 disk   <span class="comment"># &lt;--- This drive is the one</span></span><br></pre></td></tr></table></figure><p>There could be a few different things going on at this point.</p><ul><li>The routing between the SM3257 (USB controller) and NAND flash is incorrect.</li><li>Some configuration is necessary on the SM3257.</li><li>Something else I’m missing.</li></ul><h2 id="Into-the-Jank"><a href="#Into-the-Jank" class="headerlink" title="Into the Jank"></a>Into the Jank</h2><p>I started googling around for information on the SM3257EN (my USB controller IC). This led me to a <a target="_blank" rel="noopener" href="https://flashboot.ru/files/file/454/">Russian site</a> with a download link for a “SMI MP Tool”. The download contains a Windows executable for working with the SM3257EN. I fired up a Windows 10 VM and got the GUI working, but the software failed to detect the drive. I messed around with this for when felt like ages. I had nearly given up about when the sortware might have been developed. I thought it was probably the Windows XP era. Miraculusly, switching to an XP VM actually worked: the software finally detected the drive.<br><img src="/img/usb_winxp-2.png"></p><p>This is one of the many interfaces, don’t ask me what anything means.<br><img src="/img/usb_winxp-3.png"><br>At this point, I had zero documentation beyond the Russian comment section. I dedicated 30 minutes a day to “flash drive fuck around time” or FD-FAT, for short. I would fire up the Windows XP VM, press random buttons in the software and try to flash config files to the drive. I became utterly defeated and started wondering if this was even possible.</p><p>One day, I was in a FD-FAT session, pressing random buttons, when suddenly the GUI spat out, <code>ISP can&#39;t be found!!</code>. I googled this and ended up on the same <a target="_blank" rel="noopener" href="https://www.usbdev.ru/articles/a_smi/ispcantbefound/">Russian Site</a>. From this webpage I found the “DYNA MPTool”. I downloaded this, hit the “Start” button, and somehow it provisioned the drive! I now had a 2GB flash drive I built from scratch! I have no idea how this worked, so don’t ask me.</p><h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><p>I used a few test applications. I started with badblock, which tests for spaces in memory that don’t work. Badblock doesn’t care about filesystems or partitions. It looks at a block device, which is why you specify &#x2F;dev&#x2F;sdf over a partition. It simply writes known data test patterns to the memory and reads them back.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[machinehum@whitebox ~]$ sudo badblocks -w -s -o error.log /dev/sdf</span><br><span class="line">Testing with pattern 0xaa: done</span><br><span class="line">Reading and comparing: done</span><br><span class="line">Testing with pattern 0x55: done</span><br><span class="line">Reading and comparing: done</span><br><span class="line">Testing with pattern 0xff: done</span><br><span class="line">Reading and comparing: done</span><br><span class="line">Testing with pattern 0x00: done</span><br><span class="line">Reading and comparing: done</span><br></pre></td></tr></table></figure><p>With this working, I moved over to f3, which is partition aware. It works with files rather than raw memory blocks. These files are a pseudorandom bit sequence rather than a test pattern. It can then verify the data written and verify the speed.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[machinehum@whitebox ~]$ sudo f3write mnt/</span><br><span class="line">F3 write 8.0</span><br><span class="line">Copyright (C) 2010 Digirati Internet LTDA.</span><br><span class="line">This is free software; see the source for copying conditions.</span><br><span class="line"></span><br><span class="line">Free space: 1.91 GB</span><br><span class="line">Creating file 1.h2w ... OK!</span><br><span class="line">Creating file 2.h2w ... OK!</span><br><span class="line">Free space: 16.00 MB</span><br><span class="line">Average writing speed: 4.50 MB/s</span><br><span class="line">[machinehum@whitebox ~]$ ls mnt/</span><br><span class="line">1.h2w  2.h2w  lost+found</span><br><span class="line">[machinehum@whitebox ~]$ sudo f3read mnt/</span><br><span class="line">F3 read 8.0</span><br><span class="line">Copyright (C) 2010 Digirati Internet LTDA.</span><br><span class="line">This is free software; see the source for copying conditions.</span><br><span class="line"></span><br><span class="line">                  SECTORS      ok/corrupted/changed/overwritten</span><br><span class="line">Validating file 1.h2w ... 2097152/        0/      0/      0</span><br><span class="line">Validating file 2.h2w ... 1882432/        0/      0/      0</span><br><span class="line"></span><br><span class="line">  Data OK: 1.9 GB (3979584 sectors)</span><br><span class="line">Data LOST: 0 MB (0 sectors)</span><br><span class="line">	       Corrupted: 0.00 Byte (0 sectors)</span><br><span class="line">	Slightly changed: 0.00 Byte (0 sectors)</span><br><span class="line">	     Overwritten: 0.00 Byte (0 sectors)</span><br><span class="line">Average reading speed: 13.12 MB/s</span><br></pre></td></tr></table></figure><p>Definitely not the fasted drive on the market, but it looks to be working. At this point, I’m thrilled. Time to blow it up!</p><h2 id="Inhibit-Circuity"><a href="#Inhibit-Circuity" class="headerlink" title="Inhibit Circuity"></a>Inhibit Circuity</h2><p>I then flew some wires to the programming pads of the microcontroller. I probably won’t go for a USB bootloader, but I’ll need a better programming method in the future.<br><img src="/img/atmel-header.jpg"></p><p>In the last post I explained how the flash memory’s chip select line is “or’d” with a pin from the microcontroller. This can be used to inhibit the flash. I tested this out, and it worked beautifully. When you try to mount the device, the mount command hangs for 20 seconds, then dmesg spits this out:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[3064125.755814] usb 3-1: reset high-speed USB device number 84 using ehci-pci</span><br><span class="line">[3064125.906688] usb 3-1: device firmware changed</span><br><span class="line">[3064125.906832] sd 6:0:0:0: [sdf] tag#0 FAILED Result: hostbyte=DID_TIME_OUT driverbyte=DRIVER_OK cmd_age=31s</span><br><span class="line">[3064125.906844] sd 6:0:0:0: [sdf] tag#0 CDB: Read(10) 28 00 00 3f 57 80 00 00 08 00</span><br><span class="line">[3064125.906842] usb 3-1: USB disconnect, device number 84</span><br><span class="line">[3064125.906851] I/O error, dev sdf, sector 4151168 op 0x0:(READ) flags 0x80700 phys_seg 1 prio class 2</span><br><span class="line">[3064125.919296] device offline error, dev sdf, sector 4151168 op 0x0:(READ) flags 0x0 phys_seg 1 prio class 2</span><br><span class="line">[3064125.919314] Buffer I/O error on dev sdf1, logical block 518640, async page read</span><br><span class="line">[3064125.920698] /dev/sdf1: Can&#x27;t open blockdev</span><br></pre></td></tr></table></figure><p>This functionality is suitable for actors who might not want their drive to self-destruct but instead appear as a corrupted or broken drive.</p><h2 id="Destruction-Circuitry"><a href="#Destruction-Circuitry" class="headerlink" title="Destruction Circuitry"></a>Destruction Circuitry</h2><p>Finally, we’re getting to the good part. Recall the destruction circuit from the previous post.<br><img src="/img/distruct.png"></p><p>In this circuit C1, C2, D1, and D2 form a voltage doubler. When <code>Distruct_PWM</code> is 0V, C1 will charge to 5V. When <code>Distruct_PWM</code> goes high, the potential across C1 will go to 10V because voltages in series add. This forces current through D2 and will eventually charge C2 to 10V. When I want to kill the flash, I can enable Q1 via <code>Kill_switch</code> and short 10V to 3.3V.</p><p>I started with the original circuitry, which didn’t produce any smoke. However, when I reran our trusty f3read I got this.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[machinehum@whitebox ~]$ sudo f3read mnt/</span><br><span class="line">F3 read 8.0</span><br><span class="line">Copyright (C) 2010 Digirati Internet LTDA.</span><br><span class="line">This is free software; see the source for copying conditions.</span><br><span class="line"></span><br><span class="line">                  SECTORS      ok/corrupted/changed/overwritten</span><br><span class="line">Validating file 1.h2w ... 2097152/        0/      0/      0</span><br><span class="line">Validating file 2.h2w ... 1372480/   509952/      0/      0</span><br><span class="line"></span><br><span class="line">  Data OK: 1.65 GB (3469632 sectors)</span><br><span class="line">Data LOST: 249.00 MB (509952 sectors)</span><br><span class="line">	       Corrupted: 249.00 MB (509952 sectors)</span><br><span class="line">	Slightly changed: 0.00 Byte (0 sectors)</span><br><span class="line">	     Overwritten: 0.00 Byte (0 sectors)</span><br><span class="line">Average reading speed: 13.52 MB/s</span><br></pre></td></tr></table></figure><p>A lot of the data was intact, but 250MB was corrupted! I upgraded C2 from a 22uF to 122uF via electrolytic in parallel. I could fit 100uF on the board with two 47uF in parallel, but this is all I had lying around. I was paranoid about damaging my PC, so I powered the device with a bench supply.</p><p>I then repeated my experiment.</p><p><img src="/img/smoke.gif"></p><p>After testing the destruction circuit I plugged the drive into my PC. No partition, no block device, no dmesg logs, nothing. It looks like the USB controller IC was fried. To further analyse the damage, I replaced that USB controller IC. The new chip still couldn’t recognize the NAND flash. I think it’s fair to say she’s dead, Jim.</p><h2 id="What’s-next"><a href="#What’s-next" class="headerlink" title="What’s next?"></a>What’s next?</h2><p><img src="/img/usb-device-asm.png"></p><p>It’s been quite a long process, but I’m thrilled to say I’ve built the first spit-detecting, self-destructing flash drive. If you’re interested in following this project, my socials are below. I’m also planning to do a beta deployment of these devices soon, if this is something you might use, please reach out! I would love to hear your story.</p><hr><p>I also have YouTube content, which can be considered part 2.5 of the series.</p><style>.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%}.embed-container embed,.embed-container iframe,.embed-container object{position:absolute;top:0;left:0;width:100%;height:100%}</style><div class="embed-container"><iframe src="https://www.youtube.com/embed/Wrcy6ySjSu8" allowfullscreen frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe></div></div><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><hr><h3 id="_authors">Author</h3><div style="display:flex"><div><img src="/img/me.jpg" style="width:350px"></div><div style="margin-left:25px"><h4>Ryan Walker<p style="font-weight:400">Building open source stuff with open source stuff.</p><div style="display:flex"><div style="display:flex: 50%"><div style="display:flex;margin-top:5px;align-items:center"><img src="/img/shop.png" style="width:20px;padding-top:0;margin:0"> <a target="_blank" rel="noopener" href="https://shop.rootkitlabs.com" style="margin-left:15px">Our Shop</a></div><div style="display:flex;margin-top:5px;align-items:center"><img src="/img/email.png" style="width:20px;padding-top:0;margin:0"> <a href="malto:info@interruptlabs.ca" style="margin-left:15px">Email</a></div><div style="display:flex;margin-top:5px;align-items:center"><img src="/img/youtube.png" style="width:20px;padding-top:0;margin:0"> <a target="_blank" rel="noopener" href="https://www.youtube.com/@rootkitlabs" style="margin-left:15px">Youtube</a></div><div style="display:flex;margin-top:5px;align-items:center"><img src="/img/github.png" style="width:20px;padding-top:0;margin:0"> <a target="_blank" rel="noopener" href="https://github.com/o7-machinehum" style="margin-left:15px">GitHub</a></div></div><div style="display:flex: 50%;margin-left:10px"><div style="display:flex;margin-top:5px;align-items:center"><img src="/img/ig.jpg" style="width:20px;padding-top:0;margin:0"> <a target="_blank" rel="noopener" href="https://www.instagram.com/rootkitlabs/" style="margin-left:15px">Instagram</a></div><div style="display:flex;margin-top:5px;align-items:center"><img src="/img/discord.png" style="width:20px;padding-top:0;margin:0"> <a target="_blank" rel="noopener" href="https://discord.gg/EtZT7mjNuM" style="margin-left:15px">Discord</a></div><div style="display:flex;margin-top:5px;align-items:center"><img src="/img/twitter.png" style="width:20px;padding-top:0;margin:0"> <a target="_blank" rel="noopener" href="https://twitter.com/machinehum" style="margin-left:15px">Twitter</a></div><div style="display:flex;margin-top:5px;align-items:center"><img src="/img/rss.png" style="width:20px;padding-top:0;margin:0"> <a href="https://interruptlabs.ca/atom.xml" style="margin-left:15px">RSS Feed</a></div></div></div></h4></div></div></div></div></div></article>